@model Sale
@{
    ViewData["Title"] = "Sale Editor";

    List<Product> products = ViewBag.products ?? new List<Product>();
    List<Country> countries = ViewBag.countries ?? new List<Country>();
    List<Region> regions = ViewBag.regions ?? new List<Region>();
    List<City> cities = ViewBag.cities ?? new List<City>();
}

<div>
    <nav style="--bs-breadcrumb-divider: url(&#34;data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='8' height='8'%3E%3Cpath d='M2.5 0L1 1.5 3.5 4 1 6.5 2.5 8l4-4-4-4z' fill='currentColor'/%3E%3C/svg%3E&#34;);"
        aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a asp-controller="Home" asp-action="Index">Home</a></li>
            <li class="breadcrumb-item"><a asp-controller="Sales" asp-action="Index">Sales</a></li>
            <li class="breadcrumb-item active" aria-current="page">Editor</li>
        </ol>
    </nav>
</div>

<div>
    <h1 class="display-6">Sales Editor</h1>
</div>

<form method="POST">
    <div class="shadow-sm border px-3 rounded-2 mb-2">
        <input asp-for="SaleId" type="hidden" />

        <div asp-validation-summary="All" class="text-danger"></div>

        <div class="mb-3 row">
            <label asp-for="CustomerName" class="col-sm-2 col-form-label">Customer Name</label>
            <div class="col-sm-10">
                <input asp-for="CustomerName" type="text" class="form-control">
                <span asp-validation-for="CustomerName" class="text-danger"></span>
            </div>
        </div>

        <div class="mb-3 row">
            <label asp-for="Date" class="col-sm-2 col-form-label">Date</label>
            <div class="col-sm-10">
                <input asp-for="Date" type="text" class="form-control date-picker" autocomplete="off" readonly>
                <span asp-validation-for="Date" class="text-danger"></span>
            </div>
        </div>

        <div class="mb-3 row">
            <label asp-for="CountryCode" class="col-sm-2 col-form-label">Country</label>
            <div class="col-sm-10">
                <select asp-for="CountryCode" class="form-control">
                    <option value="">-- Select Country --</option>
                    @foreach (Country country in countries)
                    {
                        <option value="@country.CountryCode">@country.CountryName</option>
                    }
                </select>
                <span asp-validation-for="CountryCode" class="text-danger"></span>
            </div>
        </div>

        <div class="mb-3 row">
            <label asp-for="RegionCode" class="col-sm-2 col-form-label">Region/State</label>
            <div class="col-sm-10">
                <select asp-for="RegionCode" class="form-control">
                    @if (string.IsNullOrEmpty(Model.CountryCode))
                    {
                        <option value="">-- Country not selected --</option>
                    }
                    else
                    {
                        <option value="">-- Select Region/State --</option>
                        @foreach (Region region in regions)
                        {
                            <option value="@region.RegionCode">@region.RegionName</option>
                        }
                    }
                </select>
                <span asp-validation-for="RegionCode" class="text-danger"></span>
            </div>
        </div>

        <div class="mb-3 row">
            <label asp-for="CityCode" class="col-sm-2 col-form-label">City</label>
            <div class="col-sm-10">
                <select asp-for="CityCode" class="form-control">
                    @if (string.IsNullOrEmpty(Model.RegionCode))
                    {
                        <option value="">-- Region/State not selected --</option>
                    }
                    else
                    {
                        <option value="">-- Select City --</option>
                        @foreach (City city in cities)
                        {
                            <option value="@city.CityCode">@city.CityName</option>
                        }
                    }
                </select>
                <span asp-validation-for="CityCode" class="text-danger"></span>
            </div>
        </div>

        <div class="mb-3 row">
            <label asp-for="ProductId" class="col-sm-2 col-form-label">Product</label>
            <div class="col-sm-10">
                <select asp-for="ProductId" class="form-control">
                    <option value="">-- Select Product --</option>
                    @foreach (Product product in products)
                    {
                        <option value="@product.ProductId" data-price="@product.Price">@product.ProductName</option>
                    }
                </select>
                <span asp-validation-for="ProductId" class="text-danger"></span>
            </div>
        </div>

        <div class="mb-3 row">
            <label asp-for="Price" class="col-sm-2 col-form-label">Price</label>
            <div class="col-sm-10">
                <div class="input-group">
                    <div class="input-group-prepend">
                        <span class="input-group-text">₹</span>
                    </div>
                    <input asp-for="Price" type="text" class="form-control" readonly>
                </div>
                <span asp-validation-for="Price" class="text-danger"></span>
            </div>
        </div>

        <div class="mb-3 row">
            <label asp-for="Quantity" class="col-sm-2 col-form-label">Quantity</label>
            <div class="col-sm-10">
                <input asp-for="Quantity" type="text" class="form-control" autocomplete="off">
                <span asp-validation-for="Quantity" class="text-danger"></span>
            </div>
        </div>

        <div class="mb-3 row">
            <label asp-for="Total" class="col-sm-2 col-form-label">Total (₹)</label>
            <div class="col-sm-10">
                <div class="input-group">
                    <div class="input-group-prepend">
                        <span class="input-group-text">₹</span>
                    </div>
                    <input asp-for="Total" type="text" class="form-control" readonly>
                </div>
                <span asp-validation-for="Total" class="text-danger"></span>
            </div>
        </div>
    </div>

    <div class="mb-3 row">
        <div class="col-sm-12" style="text-align: right;">
            <button type="submit" class="btn btn-primary" style="width: 150px;">Save</button>
        </div>
    </div>
</form>

@section scripts
{
@{await Html.RenderPartialAsync("_ValidationScriptsPartial");}

<link href="~/lib/jquery-ui/jquery-ui.min.css" rel="stylesheet" asp-append-version="true" />
<script src="~/lib/jquery-ui/jquery-ui.min.js" asp-append-version="true"></script>

<script>
    $(document).ready(function () {
        $(function () { $(".date-picker").datepicker({ changeMonth: true, changeYear: true, yearRange: "-100:+0", dateFormat: 'dd-mm-yy', regional: "en-GB", }); });

        $("#CountryCode").change(function () {
            $countryCode = $('#CountryCode').val();
            if ($countryCode == "") {
                $("#RegionCode").html("<option value=''>-- Country not selected --</option>");
                $("#CityCode").html("<option value=''>-- Region/state not selected --</option>");
            } else {
                $("#RegionCode").html("Loading...");
                $.ajax({
                    url: '/Master/Regions',
                    data: 'countryCode=' + $countryCode,
                    method: "GET",
                    success: function (data) {
                        $("#RegionCode").html("<option value=''>-- Select region/state --</option>");
                        $.each(data, function (index, region) {
                            $("#RegionCode").append("<option value='" + region.regionCode + "'>" + region.regionName + "</option>");
                        });
                    }
                });
            }
        });

        $("#RegionCode").change(function () {
            $regionCode = $('#RegionCode').val();
            if ($regionCode == "") {
                $("#CityCode").html("<option value=''>-- Region/state not selected --</option>");
            } else {
                $("#CityCode").html("Loading...");
                $.ajax({
                    url: '/Master/Cities',
                    data: 'regionCode=' + $regionCode,
                    method: "GET",
                    success: function (data) {
                        $("#CityCode").html("<option value=''>-- Select City --</option>");
                        $.each(data, function (index, city) {
                            $("#CityCode").append("<option value='" + city.cityCode + "'>" + city.cityName + "</option>");
                        });
                    }
                });
            }
        });

        $("#ProductId").change(function () {
            $productId = $('#ProductId').val();
            if ($productId == "") {
                $("#Price").val("0");
                $("#Quantity").val("0");
                $("#Total").val("0");
            } else {
                $price = $('#ProductId :selected').data("price");
                $("#Price").val($price);
                CalculateTotal();
            }
        });

        $("#Quantity").keyup(function () {
            CalculateTotal();
        });
    });

    function CalculateTotal() {
        $quantity = $("#Quantity").val();
        $price = $("#Price").val();
        $total = $quantity * $price;

        if ($total == NaN) $("#Total").val("0");
        else $("#Total").val($total)
    }
</script>
}